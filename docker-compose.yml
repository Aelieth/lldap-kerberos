version: '3.8'
services:
  lldap:
    build:
      context: ../lldap  # Path to your forked LLDAP repo (adjust if different)
      dockerfile: Dockerfile  # Use a custom Dockerfile in your fork (see note below)
    container_name: lldap-custom
    ports:
      - "3890:3890"   # LDAP (non-TLS for test)
      - "17170:17170" # Web UI
    environment:
      - LLDAP_JWT_SECRET=your-strong-jwt-secret123!  # CHANGE TO STRONG RANDOM
      - LLDAP_KEY_SEED=your-strong-server-seed-456!  # CHANGE TO STRONG RANDOM (openssl rand -hex 32)
      - LLDAP_LDAP_BASE_DN=dc=testlab,dc=com
      - LLDAP_VERBOSE=true
      - LLDAP_LDAP_USER_DN=admin
      - LLDAP_LDAP_USER_PASS=adminpassword123!  # CHANGE IMMEDIATELY in UI after first run
      - LLDAP_PASSWORD_CHANGE_HOOK=docker exec kerberos-test /usr/bin/sync-kerberos-principal.sh
      - ENCODE_KEY=your-super-secret-shared-key-123!  # SAME IN BOTH SERVICES (strong random!)
    volumes:
      - lldap-data:/data
      - /var/run/docker.sock:/var/run/docker.sock  # Allows docker exec into kerberos (home-lab safe)
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:17170/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  kerberos-test:
    build: .  # Builds from your lldap-kerberos Dockerfile/start.sh
    container_name: kerberos-test
    depends_on:
      lldap:
        condition: service_healthy
    ports:
      - "88:88/tcp"
      - "88:88/udp"
      - "749:749/tcp"
    environment:
      - LDAP_HOST=lldap-custom
      - LDAP_PORT=3890
      - LDAP_SCHEME=ldap
      - REALM_NAME=TESTLAB.COM  # Your Kerberos realm (uppercase!)
      - BASE_DN=dc=testlab,dc=com
      - KDC_DN=uid=krbkdc,ou=people,dc=testlab,dc=com
      - ADMIN_DN=uid=krbadm,ou=people,dc=testlab,dc=com
      - CONTAINER_DN=cn=kerberos,ou=groups,dc=testlab,dc=com
      - DM_DN=uid=admin,ou=people,dc=testlab,dc=com
      - DM_PASS=adminpassword123!  # Match LLDAP admin pass (update after UI change)
      - MASTER_PASS=your-strong-master-pass!
      - ADMIN_PASS=your-strong-admin-pass!
      - KDC_PASS=your-strong-kdc-pass!
      - ENCODE_KEY=your-super-secret-shared-key-123!  # EXACT SAME AS LLDAP!
    volumes:
      - kerberos-data:/var/kerberos/krb5kdc
    healthcheck:
      test: ["/usr/bin/start.sh", "healthcheck"]
      interval: 30s
      timeout: 10s
      retries: 3

volumes:
  lldap-data:
  kerberos-data:
